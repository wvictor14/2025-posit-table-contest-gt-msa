---
title: "Visualizing Multiple Sequence Aligments with r-gt!"
format: 
  html:
    toc: true
    number-sections: true
    code-tools: true
    anchor-sections: true
editor: 
  render-on-save: true
editor_options: 
  chunk_output_type: console
---

# Setup

## Libraries

```{r}
library(dplyr)
library(here)
library(tidyr)
library(gt)
library(tidysq)
library(stringr)
library(readr)
palette_aa <- readr::read_csv('palette_amino_acids.csv')
```

## Data

We take the  

```{r}
FILE_MSA <- 'example_AA_msa.fasta'
msa <- tidysq::read_fasta(FILE_MSA)

msa_tidied <- tibble(msa)


tbl_data <- msa_tidied |>  
  mutate(seq = as.character(sq) |> str_split('')) |> 
  select(-sq) |> 
  tidyr::unnest(seq) |> 
  mutate(position = row_number(), .by = name) |> 
  pivot_wider(
    id_cols = 'name',
    names_from = 'position',
    values_from = 'seq'
  )
tbl_data
```



# gt

```{r}
tbl_data |> 
  gt(rowname_col = 'name')
```



# color palette

Let's implement Clustal color palette

```{r}
target_palette <- palette_aa |> select(symbol, Chemistry_AA) |> tibble::deframe()
apply_color_to_aa <- function(letter) {
  target_palette[letter]
}

tbl_data |> 
  gt(rowname_col = 'name') |> 
  data_color(fn = apply_color_to_aa)
```


```{r}
data_color_msa <- function(
    ...,
    palette = c(
      'Chemistry_AA', 
      'Shapely_AA', 
      'Zappo_AA', 
      'Taylor_AA', 
      'LETTER',  
      'Hydrophobicity'
    )
) {
  target_palette <- palette_aa[,c('symbol', palette[1])] |> tibble::deframe()
  apply_color_to_aa <- function(letter) {
    target_palette[letter]
  }
  return(gt::data_color(fn = apply_color_to_aa, ...))
}

tbl_data |> 
  gt(rowname_col = 'name') |> 
  data_color_msa()

tbl_data |> 
  gt(rowname_col = 'name') |> 
  data_color_msa(palette = 'Shapely_AA')


tbl_data |> 
  gt(rowname_col = 'name') |> 
  data_color_msa(palette = 'Zappo_AA')

tbl_data |> 
  gt(rowname_col = 'name') |> 
  data_color_msa(palette = 'LETTER')
```


# theme

- remove the borders

```{r}

tbl_data |> 
  gt(rowname_col = 'name') |> 
  data_color_msa()

tbl_data |> 
  gt(rowname_col = 'name') |> 
  data_color_msa() |> 
  tab_style(
    style = list(
      cell_borders(
        sides = 'all',
        weight = px(0)
      )
    ),
    locations = list(
      cells_body()
    )
  )

```

```{r}
tbl_data2 <- msa_tidied |>  
  mutate(seq = as.character(sq) |> str_split('')) |> 
  select(-sq) |> 
  tidyr::unnest(seq) |> 
  mutate(position = row_number(), .by = name) |> 
  pivot_wider(
    id_cols = 'name',
    names_from = 'position',
    values_from = 'seq',
    names_prefix = 'pos'
  )

tbl_data2 |> 
  gt(rowname_col = 'name') |> 
  gt::cols_label_with(fn = \(x)stringr::str_remove(x, 'pos')) |> 
  data_color_msa()
```


# consensus sequence

2 tab summaries: 

Bar chart that shows the frequency of the most frequent AA by position

Consensus sequence, shows most frequent

```{r}
gt_base <- tbl_data |> 
  gt(rowname_col = 'name') |> 
  data_color_msa() |> 
  tab_style(
    style = list(
      cell_borders(
        sides = 'all',
        weight = px(0)
      )
    ),
    locations = list(
      cells_body()
    )
  )
```

```{r}
frequency_tbl <- tbl_data[['1']] |> table() |>  sort(decreasing = TRUE)
consensus_letter <- names(frequency_tbl)[1]
consensus_freq <- (frequency_tbl/sum(frequency_tbl))[1]

paste0(consensus_letter, ":", consensus_freq)
```


```{r}
get_consensus <- function(x) {
  frequency_tbl <- x |> table() |>  sort(decreasing = TRUE)
  consensus_letter <- names(frequency_tbl)[1]
  consensus_freq <- (frequency_tbl/sum(frequency_tbl))[1]
  paste0(consensus_letter, ":", consensus_freq)
}

gt_base |> 
  grand_summary_rows(
    columns = everything(),
    fns = list(
      consensus ~ get_consensus(.)
    )
  )
```


```{r}
library(htmltools)
library(glue)


create_html_vertical_bar <- function(bar_height = .5) {
  .bar_height <- bar_height*100
  div(
    style="width:20px;height:50px;",
    div(style=glue("height:{.bar_height}%;background:white")),
    div(style=glue("height:{100-.bar_height}%;background:#4a6fa5"))
  )
}

create_html_vertical_bar(0.5) |>  browsable()
```

```{r}

#' returns a 1-length named character vector of the most frequent amino acid, where:
#'  - the value is the frequency
#'  - the name is amino acid
#'  
#' Does not handle ties (one of the ties will be returned)
get_consensus <- function(x) {
  
  # drop gaps
  frequency_tbl <- x |> table() |>  sort(decreasing = TRUE)
  consensus_freq <- (frequency_tbl/sum(frequency_tbl))[1]
  
  return(consensus_freq)
}
tbl_data[['20']] |> get_consensus()

#' This version sets the parent div to be 100% width and height
#' @param bar_height a number between 0 and 1 that sets the height of the bar as a percentage of the total height of the container (the parent) div
#' @param parent_div_height valid css unit for height of the parent div
#' @param parent_div_width valid css unit for width of the parent div
create_html_vertical_bar <- function(
    bar_height = .5,
    bar_color = '#4a6fa5',
    parent_div_height = '50px', 
    parent_div_width = '20px'
) {
  .bar_height <- bar_height*100
  div(
    style=glue("width:{parent_div_width};height:{parent_div_height};margin:0;padding:0;"),
    div(style=glue("height:{100-.bar_height}%;background:transparent;margin:0;padding:0;")),
    div(style=glue("height:{.bar_height}%;background:{bar_color};margin:0;padding:0;"))
  )
}


#' gets the consensus of the vector x, and returns an html bar
get_consensus_return_bar <- function(x) {
  consensus_freq <- get_consensus(x)
  create_html_vertical_bar(consensus_freq) 
}
tbl_data[['1']] |>  get_consensus_return_bar()  |> browsable()

c('X', 'X')|>  get_consensus_return_bar()  
```


```{r}
gt_base |> 
  grand_summary_rows(
    columns = everything(),
    fns = list(
      consensus_bar ~ get_consensus_return_bar(.) |> div(style = 'width:20px;height:50px;') |> as.character(),
      consensus_seq ~ names(get_consensus(.)) |> 
        
        # change to double dash, otherwise fmt_markdown turns it into a list (ul)
        stringr::str_replace('-', '--')
    ),
    fmt =   list(
      bar ~  fmt_markdown(.)
#      "consensus" ~ fmt_passthrough(.) # doesn't work
    )
  ) |> 
  tab_options(grand_summary_row.padding.horizontal = px(1)) 
```

I would like to apply the color palette to the summary row. It seems that there is no option to apply `data_color` to `summary_rows` [#1981](https://github.com/rstudio/gt/discussions/1981). (I actually forgot that I opened this issue myself - guess that means this is a function I would use often in my workflows)


# position

Show position every 5 AA or something like that

Leverage `scales` to generate `breaks` like ggplot2 does

